language: cpp
sudo: required
cache:
    ccache: true
    directories:
        - $TRAVIS_BUILD_DIR/build/deps
matrix:
    include:
        - os: linux
          env:
            - BUILDING_FOR_OS=linux
            - CMAKE_BUILD_FLAGS="-DCOVERAGE=ON"
            - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
            - CPU_COUNT=$(nproc)
          addons:
              apt:
                  packages:
                      - g++-7
                      - valgrind
                      - gawk
                      - sed
                      - shtool
                      - libffi-dev
                      - libprocps4-dev
                      - yasm
                      - texinfo
                      - flex
                      - bison
                  sources: &sources
                      - ubuntu-toolchain-r-test
          before_script:
              - echo "========================================= before_script (coverage)"
              - sudo apt-get update -qq
              - sudo python -m pip install --upgrade pip
              - sudo python -m pip install pyopenssl ndg-httpsclient pyasn1
              - sudo python -m pip install requests[security]
              - sudo python -m pip install codecov --ignore-installed
              - echo "========================================= before_script (codecov installed)"
              - mkdir -p build
              - cd build
              - cd ..
          after_success:
              - cd build
              - echo "========================================= after_success (coverage)"
              - ./bls_unit_test || travis_terminate 1
              - ./dkg_unit_test || travis_terminate 1
              - ./bls_test || travis_terminate 1
              - ./threshold_encryption/te_unit_test || travis_terminate 1
              - ./threshold_encryption/te_test || travis_terminate 1
              - ./threshold_encryption/dkg_te_unit_test || travis_terminate 1
              - cd ..
              - ./get_code_cov
              - echo "========================================= after_success (coverage gathered to gcov files)"
              - codecov
              - bash <(curl -s https://codecov.io/bash)
              - echo "========================================= after_success (coverage end)"
        - os: linux
          env:
            - BUILDING_FOR_OS=linux
            - CMAKE_BUILD_FLAGS=""
            - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
            - CPU_COUNT=$(nproc)
          addons:
              apt:
                  packages:
                      - g++-7
                      - valgrind
                      - gawk
                      - sed
                      - lcov
                      - yasm
                      - texinfo
                      - shtool
                      - libprocps4-dev
                  sources: &sources
                      - ubuntu-toolchain-r-test
        - os: linux
          env:
            - PYTHON=3.6
            - BUILDING_FOR_OS=linux
            - CMAKE_BUILD_FLAGS="-DBUILD_WITH_FPIC=ON"
            - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
            - CPU_COUNT=$(nproc)
          addons:
              apt:
                  packages:
                      - g++-7
                      - valgrind
                      - gawk
                      - sed
                      - lcov
                      - yasm
                      - texinfo
                      - shtool
                      - libprocps4-dev
                      - python3.6
                      - python3.6-dev
                  sources: &sources
                      - deadsnakes
                      - ubuntu-toolchain-r-test
          before_script:
              - sudo apt-get update
              - sudo apt-get install python3.6
              - sudo apt-get install python3-pip
              - sudo apt-get install python3-setuptools
              - python3.6 -m pip install coincurve
          after_success:
              - cd python
              - echo "========================================= after_success (dkg)"
              - ./setup.sh || travis terminate 1
              - ./test.sh || travis terminate 1
              - cd ..
        - os: osx
          osx_image: xcode10.1
          env:
            - BUILDING_FOR_OS=osx
            - CMAKE_BUILD_FLAGS="-DWITH_PROCPS=OFF"
            - OPENSSL_ROOT_DIR=/usr/local/opt/openssl
            - LIBTOOL=glibtool
            - CPU_COUNT=$(sysctl -n hw.physicalcpu )
          addons:
              apt:
                  packages:
                      - yasm
                      - texinfo
                      - shtool
                      - libtool
          before_script:
              - ln -s $(which glibtool) /usr/local/bin/libtool || true
              - ln -s $(which glibtoolize) /usr/local/bin/libtoolize || true
before_install:
    - eval "${MATRIX_EVAL}"
script:
    - echo "========================================= script (1)"
    - echo "CMAKE_BUILD_FLAGS=$CMAKE_BUILD_FLAGS"
    - cd deps
    - travis_wait ./build.sh PARALLEL_COUNT=$CPU_COUNT &> ./log_of_deps_build.txt || (cat ./log_of_deps_build.txt && travis_terminate 1)
    - cd ..
    - mkdir -p build
    - cd build
    - cmake $CMAKE_BUILD_FLAGS ..
    - cmake --build . -- -j$CPU_COUNT
    - cd ..
    - echo "========================================= script (2)"
notifications:
    email:
        recipients:
            - sergiy@skalelabs.com
        on_success: change
        on_failure: always
