language: generic
sudo: required
branches:
    only:
        - travis-ci
matrix:
    include:
        - os: linux
          env: BUILDING_FOR_OS=linux CXX=g++-7 CC=gcc-7 CMAKE_BUILD_FLAGS="-DCOVERAGE=ON" CODECOV_TOKEN="77018e0e-be89-47c6-8db5-cbde75153dce"
          addons:
              apt:
                  packages:
                      - g++-7
                      - valgrind
                      - gawk
                      - sed
                      - lcov
                      - libboost-dev
                  sources: &sources
                      - ubuntu-toolchain-r-test
          before_script:
              - echo "========================================= before_script (coverage)"
              - gem install coveralls-lcov
              - mkdir -p build
              - cd build
              - lcov --directory . --zerocounters
              - cd ..
          after_success:
              - cd build
              - echo "========================================= after_success (coverage)"
              - make test
              - cd ..
              - lcov --directory . --capture --output-file coverage.info # capture coverage info
              - lcov --list coverage.info # debug before upload
              - coveralls-lcov coverage.info # for open source
              - codecov
              - echo "========================================="
        - os: linux
          env: BUILDING_FOR_OS=linux CXX=g++-7 CC=gcc-7 CMAKE_BUILD_FLAGS=""
          addons:
              apt:
                  packages:
                      - g++-7
                      - valgrind
                      - gawk
                      - sed
                      - lcov
                      - libboost-dev
                  sources: &sources
                      - ubuntu-toolchain-r-test
        - os: osx
          osx_image: xcode10.1
          env: BUILDING_FOR_OS=osx CMAKE_BUILD_FLAGS=""
          addons:
              apt:
                  packages:
                      - boost
script:
    - echo "========================================= script (1)"
    - echo "CMAKE_BUILD_FLAGS=$CMAKE_BUILD_FLAGS"
    - mkdir -p build
    - cd build
    - cmake $CMAKE_BUILD_FLAGS ..
    - make
    - cd ..
    - echo "========================================= script (2)"
notifications:
    email:
        recipients:
            - sergiy@skalelabs.com
        on_success: change
        on_failure: always
